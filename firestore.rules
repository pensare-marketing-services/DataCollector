/**
 * # Firestore Security Rules: GatherWise App
 *
 * ## Core Philosophy
 * This ruleset enforces a strict user-ownership model. The primary goal is to ensure
 * that user-submitted data is private and can only be managed by the user who created it.
 * Anonymous users are permitted to sign in and submit their data once, after which
 * that data record is tied exclusively to their anonymous user ID.
 *
 * ## Data Structure
 * The data is organized in a single top-level collection:
 * - `/gatherwise_users/{gatherwiseUserId}`: Each document in this collection represents
 *   a single data submission from a unique user. The document ID (`gatherwiseUserId`)
 *   must match the UID of the submitting user.
 *
 * ## Key Security Decisions
 * - **Strict Ownership**: All operations (read, update, delete) on a user's data
 *   document are restricted to the authenticated user who owns that document.
 * - **No Public Listing**: To protect user privacy and prevent data scraping, listing
 *   the entire `gatherwise_users` collection is explicitly disallowed for all clients.
 *   Access for a future admin dashboard would require separate, more privileged rules.
 * - **Create-Once**: A user can create their own document, but the rules are structured
 *   such that a user is associated with a single document via their UID.
 * - **Default Deny**: Any operation not explicitly granted is denied.
 *
 * ## Denormalization for Authorization
 * To ensure data integrity and simple, performant rules, we require that each
 * `gatherwise_user` document contains an `id` field. The rules enforce that this
 * `id` field matches the authenticated user's UID upon creation and remains
 * immutable thereafter. This links the document's content to its owner without
 * requiring any extra lookups.
 *
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if the request is from a signed-in user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the requesting user's UID matches the provided userId.
     * This is the foundation of the ownership model.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * For update/delete operations, checks if the document exists AND the
     * requester is the owner. Prevents modifying non-existent data.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * Validates incoming data on creation. In Prototyping Mode, this is limited
     * to fields critical for authorization and relational integrity.
     * - Enforces that the document's internal `id` field matches the owner's UID.
     */
    function isValidCreateData(userId) {
      return request.resource.data.id == userId;
    }

    /**
     * Validates incoming data on update. In Prototyping Mode, this is limited
     * to ensuring critical relational fields are immutable.
     * - Enforces that the ownership link (`id` field) cannot be changed.
     */
    function isValidUpdateData() {
      return request.resource.data.id == resource.data.id;
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description
     * Controls access to individual user data submissions. A user can only create,
     * read, update, or delete their own data document.
     *
     * @path /gatherwise_users/{gatherwiseUserId}
     *
     * @allow (get) An authenticated user (UID 'user123') reading their own document at `/gatherwise_users/user123`.
     * @allow (create) An anonymous authenticated user (UID 'anon456') creating their own document at `/gatherwise_users/anon456` with `{id: 'anon456', ...}` in the body.
     * @deny (list) Any user, authenticated or not, trying to list all documents in the collection.
     * @deny (update) An authenticated user (UID 'user123') trying to update a document owned by another user at `/gatherwise_users/user789`.
     *
     * @principle
     * Enforces a strict document ownership model where a user's access is confined
     * to the data record that corresponds to their own user ID.
     */
    match /gatherwise_users/{gatherwiseUserId} {
      allow get: if isOwner(gatherwiseUserId);
      allow list: if false; // Deny listing to protect all users' privacy.
      allow create: if isOwner(gatherwiseUserId) && isValidCreateData(gatherwiseUserId);
      allow update: if isExistingOwner(gatherwiseUserId) && isValidUpdateData();
      allow delete: if isExistingOwner(gatherwiseUserId);
    }
  }
}